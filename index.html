<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Routing...</title>
    <style>
        body { 
            background-color: #f5f5f7; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            margin: 0; 
            color: #1d1d1f; 
        }
        #msg { font-weight: 500; font-size: 17px; }
    </style>
</head>
<body>
    
    <div id="msg"></div>

    <script>
        const PUBLIC_API_URL = "https://azpredictor.site/bookies/route.php";

        async function executeInstantRedirect() {
            try {
                // Fetch IP and Routing Data simultaneously using a faster, unmetered API
                const [ipResponse, jsonResponse] = await Promise.all([
                    fetch('https://get.geojs.io/v1/ip/country.json'),
                    fetch(PUBLIC_API_URL)
                ]);

                if (!ipResponse.ok || !jsonResponse.ok) throw new Error('Network failure');

                const [ipData, routes] = await Promise.all([
                    ipResponse.json(),
                    jsonResponse.json()
                ]);

                // GeoJS returns the country name in the 'name' property
                const userCountry = ipData.name; 

                // Find the matching route (ignores uppercase/lowercase differences)
                const matchedRoute = routes.find(route => 
                    route.country && route.country.toLowerCase() === userCountry.toLowerCase()
                );

                if (matchedRoute && matchedRoute.redirect_link) {
                    
                    // Fire the tracking ping in the background. 
                    // We DO NOT 'await' this. It happens silently without slowing down the page.
                    fetch(PUBLIC_API_URL, {
                        method: 'POST',
                        keepalive: true,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'increment', country: matchedRoute.country })
                    }).catch(() => {}); // Ignore tracking errors to ensure redirect happens

                    // INSTANT REDIRECT
                    window.location.replace(matchedRoute.redirect_link);
                    
                } else {
                    document.getElementById('msg').innerText = "Content not available in your region.";
                }

            } catch (error) {
                document.getElementById('msg').innerText = "Connection blocked. Please disable adblockers.";
            }
        }

        // Execute immediately before the rest of the page even finishes thinking
        executeInstantRedirect();
    </script>
</body>
</html>
